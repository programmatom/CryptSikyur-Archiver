command backup ..\..\..\..\Backup\Backup\bin\Debug\Backup.exe -date %DATE% -trace
#opencover backup

date-format yyyy-MM-dd

fail-pause on


module basic non-split functionality

test large file
date 2014-01-01
mkdir source
date + 1
create source\large.txt -size 450000
list-verify . -sizes
.                                         -----D             source\
.          2014-01-02          2014-01-02 -A----      450000 source\large.txt [1]
endlist
call backup dynpack source archive 100000 -nosplitlargefiles -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-02 -A----         182 archive.0.dynpack [2]
.          2014-01-02          2014-01-02 -A----      450140 archive.a.dynpack [3]
.                                         -----D             source\
.          2014-01-02          2014-01-02 -A----      450000 source\large.txt [1]
endlist
call backup dynunpack archive target1
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-02 -A----         182 archive.0.dynpack [2]
.          2014-01-02          2014-01-02 -A----      450140 archive.a.dynpack [3]
.                                         -----D             source\
.          2014-01-02          2014-01-02 -A----      450000 source\large.txt [1]
.                                         -----D             target1\
.          2014-01-02          2014-01-02 -A----      450000 target1\large.txt [1]
endlist
rmdir target1

test no change
date + 1
call backup dynpack source archive 100000 -nosplitlargefiles -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-03 -A----         182 archive.0.dynpack [4]
.          2014-01-02          2014-01-02 -A----      450140 archive.a.dynpack [3]
.                                         -----D             source\
.          2014-01-02          2014-01-02 -A----      450000 source\large.txt [1]
endlist
call backup dynunpack archive target2
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-03 -A----         182 archive.0.dynpack [4]
.          2014-01-02          2014-01-02 -A----      450140 archive.a.dynpack [3]
.                                         -----D             source\
.          2014-01-02          2014-01-02 -A----      450000 source\large.txt [1]
.                                         -----D             target2\
.          2014-01-02          2014-01-02 -A----      450000 target2\large.txt [1]
endlist
rmdir target2

test update file
date + 1
edit source\large.txt -size 450000
qlist .
date + 1
call backup dynpack source archive 100000 -nosplitlargefiles -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-05 -A----         182 archive.0.dynpack [6]
.          2014-01-02          2014-01-05 -A----      450140 archive.a.dynpack [7]
.                                         -----D             source\
.          2014-01-02          2014-01-04 -A----      450000 source\large.txt [5]
endlist
call backup dynunpack archive target3
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-05 -A----         182 archive.0.dynpack [6]
.          2014-01-02          2014-01-05 -A----      450140 archive.a.dynpack [7]
.                                         -----D             source\
.          2014-01-02          2014-01-04 -A----      450000 source\large.txt [5]
.                                         -----D             target3\
.          2014-01-02          2014-01-04 -A----      450000 target3\large.txt [5]
endlist
rmdir target3


module basic split functionality

test large file
date 2014-01-01
mkdir source
date + 1
create source\large.txt -size 450000
list-verify . -sizes
.                                         -----D             source\
.          2014-01-02          2014-01-02 -A----      450000 source\large.txt [1]
endlist
call backup dynpack source archive 100000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-02 -A----         809 archive.0.dynpack [2]
.          2014-01-02          2014-01-02 -A----       99995 archive.a.dynpack [3]
.          2014-01-02          2014-01-02 -A----      100000 archive.g.dynpack [4]
.          2014-01-02          2014-01-02 -A----      100001 archive.m.dynpack [5]
.          2014-01-02          2014-01-02 -A----      100001 archive.s.dynpack [6]
.          2014-01-02          2014-01-02 -A----       50806 archive.v.dynpack [7]
.                                         -----D             source\
.          2014-01-02          2014-01-02 -A----      450000 source\large.txt [1]
endlist
call backup dynunpack archive target1
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-02 -A----         809 archive.0.dynpack [2]
.          2014-01-02          2014-01-02 -A----       99995 archive.a.dynpack [3]
.          2014-01-02          2014-01-02 -A----      100000 archive.g.dynpack [4]
.          2014-01-02          2014-01-02 -A----      100001 archive.m.dynpack [5]
.          2014-01-02          2014-01-02 -A----      100001 archive.s.dynpack [6]
.          2014-01-02          2014-01-02 -A----       50806 archive.v.dynpack [7]
.                                         -----D             source\
.          2014-01-02          2014-01-02 -A----      450000 source\large.txt [1]
.                                         -----D             target1\
.          2014-01-02          2014-01-02 -A----      450000 target1\large.txt [1]
endlist
rmdir target1

test force recreate one segment
date + 1
delete archive.a.dynpack
call backup dynpack source archive 100000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-03 -A----         809 archive.0.dynpack [8]
.          2014-01-03          2014-01-03 -A----       99995 archive.a.dynpack [9]
.          2014-01-02          2014-01-02 -A----      100000 archive.g.dynpack [4]
.          2014-01-02          2014-01-02 -A----      100001 archive.m.dynpack [5]
.          2014-01-02          2014-01-02 -A----      100001 archive.s.dynpack [6]
.          2014-01-02          2014-01-02 -A----       50806 archive.v.dynpack [7]
.                                         -----D             source\
.          2014-01-02          2014-01-02 -A----      450000 source\large.txt [1]
endlist
call backup dynunpack archive target2
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-03 -A----         809 archive.0.dynpack [8]
.          2014-01-03          2014-01-03 -A----       99995 archive.a.dynpack [9]
.          2014-01-02          2014-01-02 -A----      100000 archive.g.dynpack [4]
.          2014-01-02          2014-01-02 -A----      100001 archive.m.dynpack [5]
.          2014-01-02          2014-01-02 -A----      100001 archive.s.dynpack [6]
.          2014-01-02          2014-01-02 -A----       50806 archive.v.dynpack [7]
.                                         -----D             source\
.          2014-01-02          2014-01-02 -A----      450000 source\large.txt [1]
.                                         -----D             target2\
.          2014-01-02          2014-01-02 -A----      450000 target2\large.txt [1]
endlist
rmdir target2

test shrink file (1)
date + 1
edit source\large.txt -size 350000
qlist .
date + 1
call backup dynpack source archive 100000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-05 -A----         659 archive.0.dynpack [11]
.          2014-01-03          2014-01-05 -A----       99995 archive.a.dynpack [12]
.          2014-01-02          2014-01-05 -A----      100000 archive.g.dynpack [13]
.          2014-01-02          2014-01-05 -A----      100001 archive.m.dynpack [14]
.          2014-01-02          2014-01-05 -A----       50645 archive.s.dynpack [15]
.                                         -----D             source\
.          2014-01-02          2014-01-04 -A----      350000 source\large.txt [10]
endlist
call backup dynunpack archive target3
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-05 -A----         659 archive.0.dynpack [11]
.          2014-01-03          2014-01-05 -A----       99995 archive.a.dynpack [12]
.          2014-01-02          2014-01-05 -A----      100000 archive.g.dynpack [13]
.          2014-01-02          2014-01-05 -A----      100001 archive.m.dynpack [14]
.          2014-01-02          2014-01-05 -A----       50645 archive.s.dynpack [15]
.                                         -----D             source\
.          2014-01-02          2014-01-04 -A----      350000 source\large.txt [10]
.                                         -----D             target3\
.          2014-01-02          2014-01-04 -A----      350000 target3\large.txt [10]
endlist
rmdir target3

test shrink file (2) - below split threshhold
date + 1
edit source\large.txt -size 50000
qlist .
date + 1
call backup dynpack source archive 100000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-07 -A----         183 archive.0.dynpack [17]
.          2014-01-03          2014-01-07 -A----       50140 archive.a.dynpack [18]
.                                         -----D             source\
.          2014-01-02          2014-01-06 -A----       50000 source\large.txt [16]
endlist
call backup dynunpack archive target4
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-07 -A----         183 archive.0.dynpack [17]
.          2014-01-03          2014-01-07 -A----       50140 archive.a.dynpack [18]
.                                         -----D             source\
.          2014-01-02          2014-01-06 -A----       50000 source\large.txt [16]
.                                         -----D             target4\
.          2014-01-02          2014-01-06 -A----       50000 target4\large.txt [16]
endlist
rmdir target4

test enlarge above threshhold
date + 1
edit source\large.txt -size 150000
qlist .
date + 1
call backup dynpack source archive 100000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-09 -A----         352 archive.0.dynpack [20]
.          2014-01-03          2014-01-09 -A----       99995 archive.a.dynpack [21]
.          2014-01-09          2014-01-09 -A----       50322 archive.m.dynpack [22]
.                                         -----D             source\
.          2014-01-02          2014-01-08 -A----      150000 source\large.txt [19]
endlist
call backup dynunpack archive target5
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-09 -A----         352 archive.0.dynpack [20]
.          2014-01-03          2014-01-09 -A----       99995 archive.a.dynpack [21]
.          2014-01-09          2014-01-09 -A----       50322 archive.m.dynpack [22]
.                                         -----D             source\
.          2014-01-02          2014-01-08 -A----      150000 source\large.txt [19]
.                                         -----D             target5\
.          2014-01-02          2014-01-08 -A----      150000 target5\large.txt [19]
endlist
rmdir target5


module do not gratuitously merge or split unmodified large files

test do not split
date 2014-01-01
mkdir source
create source\not-so-large -size 500000
qlist .
date + 1
call backup dynpack source archive 1000000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-02 -A----         185 archive.0.dynpack [2]
.          2014-01-02          2014-01-02 -A----      500143 archive.a.dynpack [3]
.                                         -----D             source\
.          2014-01-01          2014-01-01 -A----      500000 source\not-so-large [1]
endlist
call backup dynunpack archive target1
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-02 -A----         185 archive.0.dynpack [2]
.          2014-01-02          2014-01-02 -A----      500143 archive.a.dynpack [3]
.                                         -----D             source\
.          2014-01-01          2014-01-01 -A----      500000 source\not-so-large [1]
.                                         -----D             target1\
.          2014-01-01          2014-01-01 -A----      500000 target1\not-so-large [1]
endlist
rmdir target1
# rerun with unchanged file data, but with lower threshhold
date + 1
call backup dynpack source archive 100000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-03 -A----         185 archive.0.dynpack [4]
.          2014-01-02          2014-01-02 -A----      500143 archive.a.dynpack [3]
.                                         -----D             source\
.          2014-01-01          2014-01-01 -A----      500000 source\not-so-large [1]
endlist
call backup dynunpack archive target2
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-03 -A----         185 archive.0.dynpack [4]
.          2014-01-02          2014-01-02 -A----      500143 archive.a.dynpack [3]
.                                         -----D             source\
.          2014-01-01          2014-01-01 -A----      500000 source\not-so-large [1]
.                                         -----D             target2\
.          2014-01-01          2014-01-01 -A----      500000 target2\not-so-large [1]
endlist
rmdir target2

test do not merge
reset
date 2014-01-01
mkdir source
create source\large -size 500000
qlist .
date + 1
call backup dynpack source archive 100000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-02 -A----         937 archive.0.dynpack [2]
.          2014-01-02          2014-01-02 -A----       99995 archive.a.dynpack [3]
.          2014-01-02          2014-01-02 -A----      100000 archive.g.dynpack [4]
.          2014-01-02          2014-01-02 -A----      100001 archive.j.dynpack [5]
.          2014-01-02          2014-01-02 -A----      100001 archive.m.dynpack [6]
.          2014-01-02          2014-01-02 -A----      100001 archive.s.dynpack [7]
.          2014-01-02          2014-01-02 -A----         942 archive.v.dynpack [8]
.                                         -----D             source\
.          2014-01-01          2014-01-01 -A----      500000 source\large [1]
endlist
call backup dynunpack archive target1
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-02 -A----         937 archive.0.dynpack [2]
.          2014-01-02          2014-01-02 -A----       99995 archive.a.dynpack [3]
.          2014-01-02          2014-01-02 -A----      100000 archive.g.dynpack [4]
.          2014-01-02          2014-01-02 -A----      100001 archive.j.dynpack [5]
.          2014-01-02          2014-01-02 -A----      100001 archive.m.dynpack [6]
.          2014-01-02          2014-01-02 -A----      100001 archive.s.dynpack [7]
.          2014-01-02          2014-01-02 -A----         942 archive.v.dynpack [8]
.                                         -----D             source\
.          2014-01-01          2014-01-01 -A----      500000 source\large [1]
.                                         -----D             target1\
.          2014-01-01          2014-01-01 -A----      500000 target1\large [1]
endlist
rmdir target1
# rerun with unchanged file data, but with higher threshhold
date + 1
call backup dynpack source archive 1000000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-03 -A----         937 archive.0.dynpack [9]
.          2014-01-02          2014-01-02 -A----       99995 archive.a.dynpack [3]
.          2014-01-02          2014-01-02 -A----      100000 archive.g.dynpack [4]
.          2014-01-02          2014-01-02 -A----      100001 archive.j.dynpack [5]
.          2014-01-02          2014-01-02 -A----      100001 archive.m.dynpack [6]
.          2014-01-02          2014-01-02 -A----      100001 archive.s.dynpack [7]
.          2014-01-02          2014-01-02 -A----         942 archive.v.dynpack [8]
.                                         -----D             source\
.          2014-01-01          2014-01-01 -A----      500000 source\large [1]
endlist
call backup dynunpack archive target2
exitcode-verify 0
list-verify . -sizes
.          2014-01-02          2014-01-03 -A----         937 archive.0.dynpack [9]
.          2014-01-02          2014-01-02 -A----       99995 archive.a.dynpack [3]
.          2014-01-02          2014-01-02 -A----      100000 archive.g.dynpack [4]
.          2014-01-02          2014-01-02 -A----      100001 archive.j.dynpack [5]
.          2014-01-02          2014-01-02 -A----      100001 archive.m.dynpack [6]
.          2014-01-02          2014-01-02 -A----      100001 archive.s.dynpack [7]
.          2014-01-02          2014-01-02 -A----         942 archive.v.dynpack [8]
.                                         -----D             source\
.          2014-01-01          2014-01-01 -A----      500000 source\large [1]
.                                         -----D             target2\
.          2014-01-01          2014-01-01 -A----      500000 target2\large [1]
endlist
rmdir target2


module do not gratuitously merge or split unmodified large files (complex)

test do not split
date 2014-01-01
mkdir source
date + 1
create source\a -size 90000
date + 1
touch source\a -modified
date + 1
create source\not-so-large -size 500000
date + 1
touch source\not-so-large -modified
date + 1
create source\z -size 90000
date + 1
touch source\z -modified
date + 1
qlist .
call backup dynpack source archive 510000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-08          2014-01-08 -A----         431 archive.0.dynpack [4]
.          2014-01-08          2014-01-08 -A----       90132 archive.a.dynpack [5]
.          2014-01-08          2014-01-08 -A----      500143 archive.m.dynpack [6]
.          2014-01-08          2014-01-08 -A----       90132 archive.s.dynpack [7]
.                                         -----D             source\
.          2014-01-02          2014-01-03 -A----       90000 source\a [1]
.          2014-01-04          2014-01-05 -A----      500000 source\not-so-large [2]
.          2014-01-06          2014-01-07 -A----       90000 source\z [3]
endlist
date + 1
call backup dynunpack archive target1
exitcode-verify 0
list-verify . -sizes
.          2014-01-08          2014-01-08 -A----         431 archive.0.dynpack [4]
.          2014-01-08          2014-01-08 -A----       90132 archive.a.dynpack [5]
.          2014-01-08          2014-01-08 -A----      500143 archive.m.dynpack [6]
.          2014-01-08          2014-01-08 -A----       90132 archive.s.dynpack [7]
.                                         -----D             source\
.          2014-01-02          2014-01-03 -A----       90000 source\a [1]
.          2014-01-04          2014-01-05 -A----      500000 source\not-so-large [2]
.          2014-01-06          2014-01-07 -A----       90000 source\z [3]
.                                         -----D             target1\
.          2014-01-02          2014-01-03 -A----       90000 target1\a [1]
.          2014-01-04          2014-01-05 -A----      500000 target1\not-so-large [2]
.          2014-01-06          2014-01-07 -A----       90000 target1\z [3]
endlist
rmdir target1
# rerun with unchanged file data, but with lower threshhold
date + 1
call backup dynpack source archive 100000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-08          2014-01-10 -A----         431 archive.0.dynpack [8]
.          2014-01-08          2014-01-08 -A----       90132 archive.a.dynpack [5]
.          2014-01-08          2014-01-08 -A----      500143 archive.m.dynpack [6]
.          2014-01-08          2014-01-08 -A----       90132 archive.s.dynpack [7]
.                                         -----D             source\
.          2014-01-02          2014-01-03 -A----       90000 source\a [1]
.          2014-01-04          2014-01-05 -A----      500000 source\not-so-large [2]
.          2014-01-06          2014-01-07 -A----       90000 source\z [3]
endlist
date + 1
call backup dynunpack archive target2
exitcode-verify 0
list-verify . -sizes
.          2014-01-08          2014-01-10 -A----         431 archive.0.dynpack [8]
.          2014-01-08          2014-01-08 -A----       90132 archive.a.dynpack [5]
.          2014-01-08          2014-01-08 -A----      500143 archive.m.dynpack [6]
.          2014-01-08          2014-01-08 -A----       90132 archive.s.dynpack [7]
.                                         -----D             source\
.          2014-01-02          2014-01-03 -A----       90000 source\a [1]
.          2014-01-04          2014-01-05 -A----      500000 source\not-so-large [2]
.          2014-01-06          2014-01-07 -A----       90000 source\z [3]
.                                         -----D             target2\
.          2014-01-02          2014-01-03 -A----       90000 target2\a [1]
.          2014-01-04          2014-01-05 -A----      500000 target2\not-so-large [2]
.          2014-01-06          2014-01-07 -A----       90000 target2\z [3]
endlist
rmdir target2

test do not merge
reset
date 2014-01-01
mkdir source
date + 1
create source\a -size 1000
date + 1
touch source\a -modified
date + 1
create source\large -size 500000
date + 1
touch source\large -modified
date + 1
create source\z -size 1000
date + 1
touch source\z -modified
date + 1
qlist .
call backup dynpack source archive 100000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-08          2014-01-08 -A----        1135 archive.0.dynpack [4]
.          2014-01-08          2014-01-08 -A----        1131 archive.a.dynpack [5]
.          2014-01-08          2014-01-08 -A----       99995 archive.g.dynpack [6]
.          2014-01-08          2014-01-08 -A----      100000 archive.j.dynpack [7]
.          2014-01-08          2014-01-08 -A----      100001 archive.m.dynpack [8]
.          2014-01-08          2014-01-08 -A----      100001 archive.p.dynpack [9]
.          2014-01-08          2014-01-08 -A----      100001 archive.s.dynpack [10]
.          2014-01-08          2014-01-08 -A----        2022 archive.v.dynpack [11]
.                                         -----D             source\
.          2014-01-02          2014-01-03 -A----        1000 source\a [1]
.          2014-01-04          2014-01-05 -A----      500000 source\large [2]
.          2014-01-06          2014-01-07 -A----        1000 source\z [3]
endlist
date + 1
call backup dynunpack archive target1
exitcode-verify 0
list-verify . -sizes
.          2014-01-08          2014-01-08 -A----        1135 archive.0.dynpack [4]
.          2014-01-08          2014-01-08 -A----        1131 archive.a.dynpack [5]
.          2014-01-08          2014-01-08 -A----       99995 archive.g.dynpack [6]
.          2014-01-08          2014-01-08 -A----      100000 archive.j.dynpack [7]
.          2014-01-08          2014-01-08 -A----      100001 archive.m.dynpack [8]
.          2014-01-08          2014-01-08 -A----      100001 archive.p.dynpack [9]
.          2014-01-08          2014-01-08 -A----      100001 archive.s.dynpack [10]
.          2014-01-08          2014-01-08 -A----        2022 archive.v.dynpack [11]
.                                         -----D             source\
.          2014-01-02          2014-01-03 -A----        1000 source\a [1]
.          2014-01-04          2014-01-05 -A----      500000 source\large [2]
.          2014-01-06          2014-01-07 -A----        1000 source\z [3]
.                                         -----D             target1\
.          2014-01-02          2014-01-03 -A----        1000 target1\a [1]
.          2014-01-04          2014-01-05 -A----      500000 target1\large [2]
.          2014-01-06          2014-01-07 -A----        1000 target1\z [3]
endlist
rmdir target1
# rerun with unchanged file data, but with higher threshhold
date + 1
call backup dynpack source archive 1000000 -verify
exitcode-verify 0
list-verify . -sizes
.          2014-01-08          2014-01-10 -A----        1135 archive.0.dynpack [12]
.          2014-01-08          2014-01-08 -A----        1131 archive.a.dynpack [5]
.          2014-01-08          2014-01-08 -A----       99995 archive.g.dynpack [6]
.          2014-01-08          2014-01-08 -A----      100000 archive.j.dynpack [7]
.          2014-01-08          2014-01-08 -A----      100001 archive.m.dynpack [8]
.          2014-01-08          2014-01-08 -A----      100001 archive.p.dynpack [9]
.          2014-01-08          2014-01-08 -A----      100001 archive.s.dynpack [10]
.          2014-01-08          2014-01-08 -A----        2022 archive.v.dynpack [11]
.                                         -----D             source\
.          2014-01-02          2014-01-03 -A----        1000 source\a [1]
.          2014-01-04          2014-01-05 -A----      500000 source\large [2]
.          2014-01-06          2014-01-07 -A----        1000 source\z [3]
endlist
date + 1
call backup dynunpack archive target2
exitcode-verify 0
list-verify . -sizes
.          2014-01-08          2014-01-10 -A----        1135 archive.0.dynpack [12]
.          2014-01-08          2014-01-08 -A----        1131 archive.a.dynpack [5]
.          2014-01-08          2014-01-08 -A----       99995 archive.g.dynpack [6]
.          2014-01-08          2014-01-08 -A----      100000 archive.j.dynpack [7]
.          2014-01-08          2014-01-08 -A----      100001 archive.m.dynpack [8]
.          2014-01-08          2014-01-08 -A----      100001 archive.p.dynpack [9]
.          2014-01-08          2014-01-08 -A----      100001 archive.s.dynpack [10]
.          2014-01-08          2014-01-08 -A----        2022 archive.v.dynpack [11]
.                                         -----D             source\
.          2014-01-02          2014-01-03 -A----        1000 source\a [1]
.          2014-01-04          2014-01-05 -A----      500000 source\large [2]
.          2014-01-06          2014-01-07 -A----        1000 source\z [3]
.                                         -----D             target2\
.          2014-01-02          2014-01-03 -A----        1000 target2\a [1]
.          2014-01-04          2014-01-05 -A----      500000 target2\large [2]
.          2014-01-06          2014-01-07 -A----        1000 target2\z [3]
endlist
rmdir target2


module allow splitting or merging for segments that don't exist yet I (files unchanged)
# this test is for segments that contain an un-ranged too-large file

test setup
date 2014-01-01
mkdir source
create source\00-smallish -size 1500000
create source\01-large -size 9000000
create source\02-medium -size 3000000
create source\03-small -size 1000
qlist .
date + 1
call backup dynpack source archive 10000000
exitcode-verify 0
call backup dynunpack archive target1
exitcode-verify 0
list-verify .
.          2014-01-02          2014-01-02 -A---- archive.0.dynpack [5]
.          2014-01-02          2014-01-02 -A---- archive.a.dynpack [6]
.          2014-01-02          2014-01-02 -A---- archive.m.dynpack [7]
.          2014-01-02          2014-01-02 -A---- archive.s.dynpack [8]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\00-smallish [1]
.          2014-01-01          2014-01-01 -A---- source\01-large [2]
.          2014-01-01          2014-01-01 -A---- source\02-medium [3]
.          2014-01-01          2014-01-01 -A---- source\03-small [4]
.                                         -----D target1\
.          2014-01-01          2014-01-01 -A---- target1\00-smallish [1]
.          2014-01-01          2014-01-01 -A---- target1\01-large [2]
.          2014-01-01          2014-01-01 -A---- target1\02-medium [3]
.          2014-01-01          2014-01-01 -A---- target1\03-small [4]
endlist
rmdir target1
call backup dumppack archive.0.dynpack
exitcode-verify 0
lastoutput-verify
*SERIAL\: 4\; SIGNATURE\: .*$
. [a: 1]
.        1 1.43MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\00-smallish
. [m: 2]
.        2 8.58MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\01-large
. [s: 3]
.        3 2.86MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\02-medium
.        4 0.98KB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\03-small
endoutput

test drop target size, expected no change
date + 1
call backup dynpack source archive 5000000
exitcode-verify 0
call backup dynunpack archive target2
exitcode-verify 0
list-verify .
.          2014-01-02          2014-01-03 -A---- archive.0.dynpack [9]
.          2014-01-02          2014-01-02 -A---- archive.a.dynpack [6]
.          2014-01-02          2014-01-02 -A---- archive.m.dynpack [7]
.          2014-01-02          2014-01-02 -A---- archive.s.dynpack [8]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\00-smallish [1]
.          2014-01-01          2014-01-01 -A---- source\01-large [2]
.          2014-01-01          2014-01-01 -A---- source\02-medium [3]
.          2014-01-01          2014-01-01 -A---- source\03-small [4]
.                                         -----D target2\
.          2014-01-01          2014-01-01 -A---- target2\00-smallish [1]
.          2014-01-01          2014-01-01 -A---- target2\01-large [2]
.          2014-01-01          2014-01-01 -A---- target2\02-medium [3]
.          2014-01-01          2014-01-01 -A---- target2\03-small [4]
endlist
rmdir target2
call backup dumppack archive.0.dynpack
exitcode-verify 0
lastoutput-verify
*SERIAL\: 5\; SIGNATURE\: .*$
. [a: 1]
.        1 1.43MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\00-smallish
. [m: 2]
.        2 8.58MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\01-large
. [s: 3]
.        3 2.86MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\02-medium
.        4 0.98KB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\03-small
endoutput

test drop target size and delete segment, expected splitting
date + 1
delete archive.m.dynpack
call backup dynpack source archive 5000000
exitcode-verify 0
call backup dynunpack archive target3
exitcode-verify 0
list-verify .
.          2014-01-02          2014-01-04 -A---- archive.0.dynpack [10]
.          2014-01-02          2014-01-02 -A---- archive.a.dynpack [6]
.          2014-01-04          2014-01-04 -A---- archive.m.dynpack [11]
.          2014-01-04          2014-01-04 -A---- archive.p.dynpack [12]
.          2014-01-02          2014-01-02 -A---- archive.s.dynpack [8]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\00-smallish [1]
.          2014-01-01          2014-01-01 -A---- source\01-large [2]
.          2014-01-01          2014-01-01 -A---- source\02-medium [3]
.          2014-01-01          2014-01-01 -A---- source\03-small [4]
.                                         -----D target3\
.          2014-01-01          2014-01-01 -A---- target3\00-smallish [1]
.          2014-01-01          2014-01-01 -A---- target3\01-large [2]
.          2014-01-01          2014-01-01 -A---- target3\02-medium [3]
.          2014-01-01          2014-01-01 -A---- target3\03-small [4]
endlist
rmdir target3
call backup dumppack archive.0.dynpack
exitcode-verify 0
lastoutput-verify
*SERIAL\: 8\; SIGNATURE\: .*$
. [a: 1]
.        1 1.43MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\00-smallish
. [m: 6]
.        2 8.58MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\01-large
.   0-4999835/9000000
. [p: 7]
.        3 8.58MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\01-large
.   4999836-8999999/9000000
. [s: 3]
.        4 2.86MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\02-medium
.        5 0.98KB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\03-small
endoutput


module allow splitting or merging for segments that don't exist yet II (files unchanged)
# this test is for too-large segments containing smallish files

test setup
date 2014-01-01
mkdir source
create source\00-medium1 -size 4500000
create source\01-medium2 -size 4500000
create source\02-smallpart -size 2400000
create source\03-smallpart -size 2400000
create source\04-smallpart -size 2400000
create source\05-smallpart -size 2400000
create source\06-medium3 -size 4500000
create source\07-medium4 -size 4500000
qlist .
date + 1
call backup dynpack source archive 10000000
exitcode-verify 0
call backup dynunpack archive target1
exitcode-verify 0
list-verify .
.          2014-01-02          2014-01-02 -A---- archive.0.dynpack [9]
.          2014-01-02          2014-01-02 -A---- archive.a.dynpack [10]
.          2014-01-02          2014-01-02 -A---- archive.m.dynpack [11]
.          2014-01-02          2014-01-02 -A---- archive.s.dynpack [12]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\00-medium1 [1]
.          2014-01-01          2014-01-01 -A---- source\01-medium2 [2]
.          2014-01-01          2014-01-01 -A---- source\02-smallpart [3]
.          2014-01-01          2014-01-01 -A---- source\03-smallpart [4]
.          2014-01-01          2014-01-01 -A---- source\04-smallpart [5]
.          2014-01-01          2014-01-01 -A---- source\05-smallpart [6]
.          2014-01-01          2014-01-01 -A---- source\06-medium3 [7]
.          2014-01-01          2014-01-01 -A---- source\07-medium4 [8]
.                                         -----D target1\
.          2014-01-01          2014-01-01 -A---- target1\00-medium1 [1]
.          2014-01-01          2014-01-01 -A---- target1\01-medium2 [2]
.          2014-01-01          2014-01-01 -A---- target1\02-smallpart [3]
.          2014-01-01          2014-01-01 -A---- target1\03-smallpart [4]
.          2014-01-01          2014-01-01 -A---- target1\04-smallpart [5]
.          2014-01-01          2014-01-01 -A---- target1\05-smallpart [6]
.          2014-01-01          2014-01-01 -A---- target1\06-medium3 [7]
.          2014-01-01          2014-01-01 -A---- target1\07-medium4 [8]
endlist
rmdir target1
call backup dumppack archive.0.dynpack
exitcode-verify 0
lastoutput-verify
*SERIAL\: 4\; SIGNATURE\: .*$
. [a: 1]
.        1 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\00-medium1
.        2 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\01-medium2
. [m: 2]
.        3 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\02-smallpart
.        4 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\03-smallpart
.        5 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\04-smallpart
.        6 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\05-smallpart
. [s: 3]
.        7 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\06-medium3
.        8 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\07-medium4
endoutput

test drop target size, expected no change
date + 1
call backup dynpack source archive 5000000
exitcode-verify 0
call backup dynunpack archive target2
exitcode-verify 0
list-verify .
.          2014-01-02          2014-01-03 -A---- archive.0.dynpack [13]
.          2014-01-02          2014-01-02 -A---- archive.a.dynpack [10]
.          2014-01-02          2014-01-02 -A---- archive.m.dynpack [11]
.          2014-01-02          2014-01-02 -A---- archive.s.dynpack [12]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\00-medium1 [1]
.          2014-01-01          2014-01-01 -A---- source\01-medium2 [2]
.          2014-01-01          2014-01-01 -A---- source\02-smallpart [3]
.          2014-01-01          2014-01-01 -A---- source\03-smallpart [4]
.          2014-01-01          2014-01-01 -A---- source\04-smallpart [5]
.          2014-01-01          2014-01-01 -A---- source\05-smallpart [6]
.          2014-01-01          2014-01-01 -A---- source\06-medium3 [7]
.          2014-01-01          2014-01-01 -A---- source\07-medium4 [8]
.                                         -----D target2\
.          2014-01-01          2014-01-01 -A---- target2\00-medium1 [1]
.          2014-01-01          2014-01-01 -A---- target2\01-medium2 [2]
.          2014-01-01          2014-01-01 -A---- target2\02-smallpart [3]
.          2014-01-01          2014-01-01 -A---- target2\03-smallpart [4]
.          2014-01-01          2014-01-01 -A---- target2\04-smallpart [5]
.          2014-01-01          2014-01-01 -A---- target2\05-smallpart [6]
.          2014-01-01          2014-01-01 -A---- target2\06-medium3 [7]
.          2014-01-01          2014-01-01 -A---- target2\07-medium4 [8]
endlist
rmdir target2
call backup dumppack archive.0.dynpack
exitcode-verify 0
lastoutput-verify
*SERIAL\: 5\; SIGNATURE\: .*$
. [a: 1]
.        1 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\00-medium1
.        2 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\01-medium2
. [m: 2]
.        3 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\02-smallpart
.        4 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\03-smallpart
.        5 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\04-smallpart
.        6 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\05-smallpart
. [s: 3]
.        7 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\06-medium3
.        8 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\07-medium4
endoutput

test drop target size and delete segment, expected splitting
date + 1
delete archive.m.dynpack
call backup dynpack source archive 5000000
exitcode-verify 0
call backup dynunpack archive target3
exitcode-verify 0
list-verify .
.          2014-01-02          2014-01-04 -A---- archive.0.dynpack [14]
.          2014-01-02          2014-01-02 -A---- archive.a.dynpack [10]
.          2014-01-04          2014-01-04 -A---- archive.m.dynpack [15]
.          2014-01-04          2014-01-04 -A---- archive.p.dynpack [16]
.          2014-01-02          2014-01-02 -A---- archive.s.dynpack [12]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\00-medium1 [1]
.          2014-01-01          2014-01-01 -A---- source\01-medium2 [2]
.          2014-01-01          2014-01-01 -A---- source\02-smallpart [3]
.          2014-01-01          2014-01-01 -A---- source\03-smallpart [4]
.          2014-01-01          2014-01-01 -A---- source\04-smallpart [5]
.          2014-01-01          2014-01-01 -A---- source\05-smallpart [6]
.          2014-01-01          2014-01-01 -A---- source\06-medium3 [7]
.          2014-01-01          2014-01-01 -A---- source\07-medium4 [8]
.                                         -----D target3\
.          2014-01-01          2014-01-01 -A---- target3\00-medium1 [1]
.          2014-01-01          2014-01-01 -A---- target3\01-medium2 [2]
.          2014-01-01          2014-01-01 -A---- target3\02-smallpart [3]
.          2014-01-01          2014-01-01 -A---- target3\03-smallpart [4]
.          2014-01-01          2014-01-01 -A---- target3\04-smallpart [5]
.          2014-01-01          2014-01-01 -A---- target3\05-smallpart [6]
.          2014-01-01          2014-01-01 -A---- target3\06-medium3 [7]
.          2014-01-01          2014-01-01 -A---- target3\07-medium4 [8]
endlist
rmdir target3
call backup dumppack archive.0.dynpack
exitcode-verify 0
lastoutput-verify
*SERIAL\: 8\; SIGNATURE\: .*$
. [a: 1]
.        1 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\00-medium1
.        2 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\01-medium2
. [m: 6]
.        3 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\02-smallpart
.        4 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\03-smallpart
. [p: 7]
.        5 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\04-smallpart
.        6 2.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\05-smallpart
. [s: 3]
.        7 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\06-medium3
.        8 4.29MB 2014-01-01T00:00:00 2014-01-01T00:00:00 -- .\07-medium4
endoutput
