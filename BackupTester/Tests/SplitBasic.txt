command backup ..\..\..\..\Backup\Backup\bin\Debug\Backup.exe -date %DATE%
#opencover backup

date-format yyyy-MM-dd

fail-pause on


module degenerate test

test single file test
date 2014-01-01
create source -value "The quick brown fox jumped over the lazy dog many times."
date + 1
qlist .
call backup split source target 1000
exitcode-verify 0
list-verify .
.          2014-01-01          2014-01-01 -A---- source [1]
.          2014-01-02          2014-01-02 -A---- target.0 [1]
.          2014-01-02          2014-01-02 -A---- target.sha256 [2]
endlist
file-verify target.sha256
.bedf889a826e831278b6532189a3142329cfb74bcb23c085bf768223f7463a8e
endfile
date + 1
call backup unsplit target recombined
exitcode-verify 0
lastoutput-verify -workspacepathhack
.Incorporating %WORKSPACE%\target.0
.Incorporating %WORKSPACE%\target.sha256
.SHA256=bedf889a826e831278b6532189a3142329cfb74bcb23c085bf768223f7463a8e
.  SHA256 hashes match
endoutput
list-verify .
.          2014-01-03          2014-01-03 -A---- recombined [1]
.          2014-01-01          2014-01-01 -A---- source [1]
.          2014-01-02          2014-01-02 -A---- target.0 [1]
.          2014-01-02          2014-01-02 -A---- target.sha256 [2]
endlist

test cleanup
delete target.0
delete target.sha256
delete recombined
list-verify .
.          2014-01-01          2014-01-01 -A---- source [1]
endlist

test two file test
date + 1
qlist .
call backup split source target 30
exitcode-verify 0
list-verify .
.          2014-01-01          2014-01-01 -A---- source [1]
.          2014-01-04          2014-01-04 -A---- target.0 [3]
.          2014-01-04          2014-01-04 -A---- target.1 [4]
.          2014-01-04          2014-01-04 -A---- target.sha256 [2]
endlist
file-verify target.sha256
.bedf889a826e831278b6532189a3142329cfb74bcb23c085bf768223f7463a8e
endfile
date + 1
call backup unsplit target recombined
exitcode-verify 0
lastoutput-verify -workspacepathhack
.Incorporating %WORKSPACE%\target.0
.Incorporating %WORKSPACE%\target.1
.Incorporating %WORKSPACE%\target.sha256
.SHA256=bedf889a826e831278b6532189a3142329cfb74bcb23c085bf768223f7463a8e
.  SHA256 hashes match
endoutput
list-verify .
.          2014-01-05          2014-01-05 -A---- recombined [1]
.          2014-01-01          2014-01-01 -A---- source [1]
.          2014-01-04          2014-01-04 -A---- target.0 [3]
.          2014-01-04          2014-01-04 -A---- target.1 [4]
.          2014-01-04          2014-01-04 -A---- target.sha256 [2]
endlist

test file tampering
delete recombined
date + 1
invert-range target.0 0 1
qlist .
date + 1
call backup unsplit target recombined
exitcode-verify not 0
lastoutput-verify -workspacepathhack
.Incorporating %WORKSPACE%\target.0
.Incorporating %WORKSPACE%\target.1
.Incorporating %WORKSPACE%\target.sha256
.SHA256=9116a19ac99eefbe1217258e5c1eabe6da50a5677aca2cee26e098113562bd5c
.  SHA256 hashes do not match, FILE IS DAMAGED
endoutput
list-verify .
.          2014-01-07          2014-01-07 -A---- recombined [6]
.          2014-01-01          2014-01-01 -A---- source [1]
.          2014-01-04          2014-01-06 -A---- target.0 [5]
.          2014-01-04          2014-01-04 -A---- target.1 [4]
.          2014-01-04          2014-01-04 -A---- target.sha256 [2]
endlist
