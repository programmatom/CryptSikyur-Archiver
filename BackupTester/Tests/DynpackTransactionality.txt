command backup ..\..\..\..\Backup\Backup\bin\Debug\Backup.exe -date %DATE% -trace -tracefaultpoints
#opencover backup

date-format yyyy-MM-dd

fail-pause on

# TODO: update old behavior/current behavior to be current behavior with test that roll-back works
# several modules are suspect or obsolete


module new segment barrier basic functionality tests

test setup
date 2015-01-01
mkdir source
mkdir archive
create source\a -size 9500
create source\b -size 9500
create source\c -size 9500
create source\g -size 9500
create source\h -size 9500
create source\i -size 9500
create source\m -size 9500
create source\n -size 9500
create source\o -size 9500
create source\p -size 9500
create source\q -size 9500
create source\r -size 9500
create source\s -size 9500
create source\t -size 9500
create source\u -size 9500
qlist .

test do not create barriers on initial run
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'7-write-segment-files']/ArchiveSegment[count:3] dynpack source archive\x 30000
exitcode-verify not 0
list-verify .
.                                         -----D archive\
.          2015-01-02          2015-01-02 -A---- archive\x.0.dynpack [16]
.          2015-01-02          2015-01-02 -A---- archive\x.a.dynpack [17]
.          2015-01-02          2015-01-02 -A---- archive\x.g.dynpack [18]
.                                         -----D source\
.          2015-01-01          2015-01-01 -A---- source\a [1]
.          2015-01-01          2015-01-01 -A---- source\b [2]
.          2015-01-01          2015-01-01 -A---- source\c [3]
.          2015-01-01          2015-01-01 -A---- source\g [4]
.          2015-01-01          2015-01-01 -A---- source\h [5]
.          2015-01-01          2015-01-01 -A---- source\i [6]
.          2015-01-01          2015-01-01 -A---- source\m [7]
.          2015-01-01          2015-01-01 -A---- source\n [8]
.          2015-01-01          2015-01-01 -A---- source\o [9]
.          2015-01-01          2015-01-01 -A---- source\p [10]
.          2015-01-01          2015-01-01 -A---- source\q [11]
.          2015-01-01          2015-01-01 -A---- source\r [12]
.          2015-01-01          2015-01-01 -A---- source\s [13]
.          2015-01-01          2015-01-01 -A---- source\t [14]
.          2015-01-01          2015-01-01 -A---- source\u [15]
endlist

test ensure subsequent run is producing barriers for new segments
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'7-write-segment-files']/ArchiveSegment[count:3] dynpack source archive\x 30000
exitcode-verify not 0
list-verify .
.                                         -----D archive\
.          2015-01-03          2015-01-03 -A---- archive\x.-0.dynpack [16]
.          2015-01-03          2015-01-03 -A--Z- archive\x.-m.dynpack [0]
.          2015-01-03          2015-01-03 -A--Z- archive\x.-s.dynpack [0]
.          2015-01-02          2015-01-03 -A---- archive\x.0.dynpack [19]
.          2015-01-02          2015-01-02 -A---- archive\x.a.dynpack [17]
.          2015-01-02          2015-01-02 -A---- archive\x.g.dynpack [18]
.          2015-01-03          2015-01-03 -A---- archive\x.m.dynpack [20]
.          2015-01-03          2015-01-03 -A---- archive\x.s.dynpack [21]
.                                         -----D source\
.          2015-01-01          2015-01-01 -A---- source\a [1]
.          2015-01-01          2015-01-01 -A---- source\b [2]
.          2015-01-01          2015-01-01 -A---- source\c [3]
.          2015-01-01          2015-01-01 -A---- source\g [4]
.          2015-01-01          2015-01-01 -A---- source\h [5]
.          2015-01-01          2015-01-01 -A---- source\i [6]
.          2015-01-01          2015-01-01 -A---- source\m [7]
.          2015-01-01          2015-01-01 -A---- source\n [8]
.          2015-01-01          2015-01-01 -A---- source\o [9]
.          2015-01-01          2015-01-01 -A---- source\p [10]
.          2015-01-01          2015-01-01 -A---- source\q [11]
.          2015-01-01          2015-01-01 -A---- source\r [12]
.          2015-01-01          2015-01-01 -A---- source\s [13]
.          2015-01-01          2015-01-01 -A---- source\t [14]
.          2015-01-01          2015-01-01 -A---- source\u [15]
endlist

test ensure completion removes barriers
date + 1
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify .
.                                         -----D archive\
.          2015-01-02          2015-01-04 -A---- archive\x.0.dynpack [22]
.          2015-01-02          2015-01-02 -A---- archive\x.a.dynpack [17]
.          2015-01-02          2015-01-02 -A---- archive\x.g.dynpack [18]
.          2015-01-03          2015-01-03 -A---- archive\x.m.dynpack [20]
.          2015-01-03          2015-01-03 -A---- archive\x.s.dynpack [21]
.          2015-01-04          2015-01-04 -A---- archive\x.v.dynpack [23]
.                                         -----D source\
.          2015-01-01          2015-01-01 -A---- source\a [1]
.          2015-01-01          2015-01-01 -A---- source\b [2]
.          2015-01-01          2015-01-01 -A---- source\c [3]
.          2015-01-01          2015-01-01 -A---- source\g [4]
.          2015-01-01          2015-01-01 -A---- source\h [5]
.          2015-01-01          2015-01-01 -A---- source\i [6]
.          2015-01-01          2015-01-01 -A---- source\m [7]
.          2015-01-01          2015-01-01 -A---- source\n [8]
.          2015-01-01          2015-01-01 -A---- source\o [9]
.          2015-01-01          2015-01-01 -A---- source\p [10]
.          2015-01-01          2015-01-01 -A---- source\q [11]
.          2015-01-01          2015-01-01 -A---- source\r [12]
.          2015-01-01          2015-01-01 -A---- source\s [13]
.          2015-01-01          2015-01-01 -A---- source\t [14]
.          2015-01-01          2015-01-01 -A---- source\u [15]
endlist


module transactionality - 1 - change manifest only

test setup
date 2014-01-01
mkdir source
create source\a -size 9500
create source\b -size 9500
create source\c -size 9500
create source\g -size 9500
create source\h -size 9500
create source\i -size 9500
create source\m -size 9500
create source\n -size 9500
create source\o -size 9500
qlist .
mkdir archive
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify .
.                                         -----D archive\
.          2014-01-01          2014-01-01 -A---- archive\x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- archive\x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- archive\x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- archive\x.s.dynpack [13]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\a [1]
.          2014-01-01          2014-01-01 -A---- source\b [2]
.          2014-01-01          2014-01-01 -A---- source\c [3]
.          2014-01-01          2014-01-01 -A---- source\g [4]
.          2014-01-01          2014-01-01 -A---- source\h [5]
.          2014-01-01          2014-01-01 -A---- source\i [6]
.          2014-01-01          2014-01-01 -A---- source\m [7]
.          2014-01-01          2014-01-01 -A---- source\n [8]
.          2014-01-01          2014-01-01 -A---- source\o [9]
endlist

test basic - unchanged, failed before new manifest
# basic scenario - no changes, failure before new manifest is written
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'6-write-manifest-file'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-02          2014-01-02 -A---- x.-0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
copy archive archive-backup

test rerun with completion, ensure success (backup x.-0.dynpack will be used)
date + 1
# automatic recovery from backup manifest (*.-0.dynpack) in case of missing manifest (*.0.dynpack) was deemed risky, so manual intervention is now required in this case
# OLD BEHAVIOR
#call backup -concurrency 0 dynpack source archive\x 30000
#exitcode-verify 0
# CURRENT BEHAVIOR
# force the issue (TODO: use failure injection to do this)
delete archive\x.0.dynpack
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify not 0
lastoutput-verify -workspacepathhack
.%WORKSPACE%\source
.Reading: x.0.dynpack
.
.Error:
.Manifest file "x.0.dynpack" does not exist (backup copy "x.-0.dynpack" does exist)! Manual intervention required - may be device connectivity failure. If manifest is indeed missing, archive integrity must be verified.
*   at Backup\.Core\.DynamicPack.*$
*   at Backup\.Core\.Main.*$
endoutput
# manual intervention
copy archive\x.-0.dynpack archive\x.0.dynpack
touch archive\x.0.dynpack -created 
# rerun
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
# END OLD/CURRENT BEHAVIOR
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target1
exitcode-verify 0
dirs-equal-verify target1 source
rmdir target1

test restore previous; invoke roll-back tool to restore to previous archive
date + 1
rmdir archive
copy archive-backup archive
list-verify archive
.          2014-01-02          2014-01-02 -A---- x.-0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
# force the issue (TODO: should use failure injection to do this)
delete archive\x.0.dynpack
call backup remote archive dynpack-rollback x
exitcode-verify 0
list-verify archive
.          2014-01-04          2014-01-04 -A---- x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target2
exitcode-verify 0
dirs-equal-verify target2 source
rmdir target2


module transactionality - 2a - change segment

test setup
date 2014-01-01
mkdir source
create source\a -size 9500
create source\b -size 9500
create source\c -size 9500
create source\g -size 9500
create source\h -size 9500
create source\i -size 9500
create source\m -size 9500
create source\n -size 9500
create source\o -size 9500
qlist .
mkdir archive
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify .
.                                         -----D archive\
.          2014-01-01          2014-01-01 -A---- archive\x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- archive\x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- archive\x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- archive\x.s.dynpack [13]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\a [1]
.          2014-01-01          2014-01-01 -A---- source\b [2]
.          2014-01-01          2014-01-01 -A---- source\c [3]
.          2014-01-01          2014-01-01 -A---- source\g [4]
.          2014-01-01          2014-01-01 -A---- source\h [5]
.          2014-01-01          2014-01-01 -A---- source\i [6]
.          2014-01-01          2014-01-01 -A---- source\m [7]
.          2014-01-01          2014-01-01 -A---- source\n [8]
.          2014-01-01          2014-01-01 -A---- source\o [9]
endlist
copy source source-original

test change one segment, fail before segment written
date + 1
edit source\h -size 9500
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'7-write-segment-files']/ArchiveSegment[stringequal:'x.m.dynpack'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
copy archive archive-backup-1

test rerun with completion, ensure success (backup x.-0.dynpack will be used)
date + 1
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify archive
.          2014-01-01          2014-01-04 -A---- x.0.dynpack [15]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-04          2014-01-04 -A---- x.m.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target1
exitcode-verify 0
dirs-equal-verify target1 source
rmdir target1

test restore previous; invoke roll-back tool to restore to previous archive
date + 1
rmdir archive
copy archive-backup-1 archive
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call-with-input backup remote archive dynpack-rollback x
.y
endinput
exitcode-verify 0
lastoutput-verify
.A newer manifest also exists (x.0.dynpack). Are you sure you want to roll back? [y/n] 
.deleting x.0.dynpack
.renaming x.-0.dynpack to x.0.dynpack
.renaming x.-m.dynpack to x.m.dynpack
endoutput
list-verify archive
.          2014-01-01          2014-01-05 -A---- x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-05          2014-01-05 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target2
exitcode-verify 0
dirs-equal-verify target2 source-original
rmdir target2

test return to first failed state, run to create new x.m.dynpack and fail
date + 1
rmdir archive
copy archive-backup-1 archive
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'8-write-segment-files-completed'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-06 -A---- x.0.dynpack [18]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-06          2014-01-06 -A---- x.m.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
copy archive archive-backup-2

test rerun with completion, ensure success (backup x.-0.dynpack will be used)
date + 1
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify archive
.          2014-01-01          2014-01-07 -A---- x.0.dynpack [19]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-06          2014-01-06 -A---- x.m.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target2
exitcode-verify 0
dirs-equal-verify target2 source
rmdir target2

test restore second failed state; invoke roll-back tool to restore to previous archive
date + 1
rmdir archive
copy archive-backup-2 archive
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-06 -A---- x.0.dynpack [18]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-06          2014-01-06 -A---- x.m.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call-with-input backup remote archive dynpack-rollback x
.y
endinput
exitcode-verify 0
lastoutput-verify
.A newer manifest also exists (x.0.dynpack). Are you sure you want to roll back? [y/n] 
.deleting x.0.dynpack
.renaming x.-0.dynpack to x.0.dynpack
.deleting x.m.dynpack
.renaming x.-m.dynpack to x.m.dynpack
endoutput
list-verify archive
.          2014-01-01          2014-01-08 -A---- x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-06          2014-01-08 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target3
exitcode-verify 0
dirs-equal-verify target3 source-original
rmdir target3


module transactionality - 2b - change segment, then change it again

test setup
date 2014-01-01
mkdir source
create source\a -size 9500
create source\b -size 9500
create source\c -size 9500
create source\g -size 9500
create source\h -size 9500
create source\i -size 9500
create source\m -size 9500
create source\n -size 9500
create source\o -size 9500
qlist .
mkdir archive
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify .
.                                         -----D archive\
.          2014-01-01          2014-01-01 -A---- archive\x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- archive\x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- archive\x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- archive\x.s.dynpack [13]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\a [1]
.          2014-01-01          2014-01-01 -A---- source\b [2]
.          2014-01-01          2014-01-01 -A---- source\c [3]
.          2014-01-01          2014-01-01 -A---- source\g [4]
.          2014-01-01          2014-01-01 -A---- source\h [5]
.          2014-01-01          2014-01-01 -A---- source\i [6]
.          2014-01-01          2014-01-01 -A---- source\m [7]
.          2014-01-01          2014-01-01 -A---- source\n [8]
.          2014-01-01          2014-01-01 -A---- source\o [9]
endlist
copy source source-original

test change one segment, fail after segment written
date + 1
edit source\h -size 9500
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'8-write-segment-files-completed'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-03 -A---- x.m.dynpack [15]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist

test modify segment again, update and fail after written
date + 1
edit source\h -size 9500
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'8-write-segment-files-completed'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-05 -A---- x.0.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-05 -A---- x.m.dynpack [17]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
copy archive archive-backup-1

test rerun with completion, ensure success
date + 1
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify archive
.          2014-01-01          2014-01-06 -A---- x.0.dynpack [18]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-05 -A---- x.m.dynpack [17]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target1
exitcode-verify 0
dirs-equal-verify target1 source
rmdir target1

test restore previous; invoke roll-back tool to restore to previous archive
date + 1
rmdir archive
copy archive-backup-1 archive
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-05 -A---- x.0.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-05 -A---- x.m.dynpack [17]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call-with-input backup remote archive dynpack-rollback x
.y
endinput
exitcode-verify 0
lastoutput-verify
.A newer manifest also exists (x.0.dynpack). Are you sure you want to roll back? [y/n] 
.deleting x.0.dynpack
.renaming x.-0.dynpack to x.0.dynpack
.deleting x.m.dynpack
.renaming x.-m.dynpack to x.m.dynpack
endoutput
list-verify archive
.          2014-01-01          2014-01-07 -A---- x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-07 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target2
exitcode-verify 0
dirs-equal-verify target2 source-original
rmdir target2


module transactionality - 3a - delete segment

test setup
date 2014-01-01
mkdir source
create source\a -size 9500
create source\b -size 9500
create source\c -size 9500
create source\g -size 9500
create source\h -size 9500
create source\i -size 9500
create source\m -size 9500
create source\n -size 9500
create source\o -size 9500
qlist .
mkdir archive
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify .
.                                         -----D archive\
.          2014-01-01          2014-01-01 -A---- archive\x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- archive\x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- archive\x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- archive\x.s.dynpack [13]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\a [1]
.          2014-01-01          2014-01-01 -A---- source\b [2]
.          2014-01-01          2014-01-01 -A---- source\c [3]
.          2014-01-01          2014-01-01 -A---- source\g [4]
.          2014-01-01          2014-01-01 -A---- source\h [5]
.          2014-01-01          2014-01-01 -A---- source\i [6]
.          2014-01-01          2014-01-01 -A---- source\m [7]
.          2014-01-01          2014-01-01 -A---- source\n [8]
.          2014-01-01          2014-01-01 -A---- source\o [9]
endlist
copy source source-original

test delete segment
date + 1
delete source\g
delete source\h
delete source\i
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'8-write-segment-files-completed'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
copy archive archive-backup-1

test rerun with completion, ensure success (backup x.-0.dynpack will be used)
date + 1
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify archive
.          2014-01-01          2014-01-04 -A---- x.0.dynpack [15]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target1
exitcode-verify 0
dirs-equal-verify target1 source
rmdir target1

test restore previous; invoke roll-back tool to restore to previous archive
date + 1
rmdir archive
copy archive-backup-1 archive
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call-with-input backup remote archive dynpack-rollback x
.y
endinput
exitcode-verify 0
lastoutput-verify
.A newer manifest also exists (x.0.dynpack). Are you sure you want to roll back? [y/n] 
.deleting x.0.dynpack
.renaming x.-0.dynpack to x.0.dynpack
.renaming x.-m.dynpack to x.m.dynpack
endoutput
list-verify archive
.          2014-01-01          2014-01-05 -A---- x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-05          2014-01-05 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target2
exitcode-verify 0
dirs-equal-verify target2 source-original
rmdir target2


module transactionality - 3b - change segment, then delete it

test setup
date 2014-01-01
mkdir source
create source\a -size 9500
create source\b -size 9500
create source\c -size 9500
create source\g -size 9500
create source\h -size 9500
create source\i -size 9500
create source\m -size 9500
create source\n -size 9500
create source\o -size 9500
qlist .
mkdir archive
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify .
.                                         -----D archive\
.          2014-01-01          2014-01-01 -A---- archive\x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- archive\x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- archive\x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- archive\x.s.dynpack [13]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\a [1]
.          2014-01-01          2014-01-01 -A---- source\b [2]
.          2014-01-01          2014-01-01 -A---- source\c [3]
.          2014-01-01          2014-01-01 -A---- source\g [4]
.          2014-01-01          2014-01-01 -A---- source\h [5]
.          2014-01-01          2014-01-01 -A---- source\i [6]
.          2014-01-01          2014-01-01 -A---- source\m [7]
.          2014-01-01          2014-01-01 -A---- source\n [8]
.          2014-01-01          2014-01-01 -A---- source\o [9]
endlist
copy source source-original

test change one segment, fail after segment written
date + 1
edit source\h -size 9500
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'8-write-segment-files-completed'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-03 -A---- x.m.dynpack [15]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist

test delete segment
date + 1
delete source\g
delete source\h
delete source\i
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'8-write-segment-files-completed'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-05 -A---- x.0.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
copy archive archive-backup-1

test rerun with completion, ensure success (backup x.-0.dynpack will be used)
date + 1
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify archive
.          2014-01-01          2014-01-06 -A---- x.0.dynpack [17]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target1
exitcode-verify 0
dirs-equal-verify target1 source
rmdir target1

test restore previous; invoke roll-back tool to restore to previous archive
date + 1
rmdir archive
copy archive-backup-1 archive
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.-m.dynpack [12]
.          2014-01-01          2014-01-05 -A---- x.0.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call-with-input backup remote archive dynpack-rollback x
.y
endinput
exitcode-verify 0
lastoutput-verify
.A newer manifest also exists (x.0.dynpack). Are you sure you want to roll back? [y/n] 
.deleting x.0.dynpack
.renaming x.-0.dynpack to x.0.dynpack
.renaming x.-m.dynpack to x.m.dynpack
endoutput
list-verify archive
.          2014-01-01          2014-01-07 -A---- x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-07          2014-01-07 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target2
exitcode-verify 0
dirs-equal-verify target2 source-original
rmdir target2


module transactionality - 4a - add segment and rollback

test setup
date 2014-01-01
mkdir source
create source\a -size 9500
create source\b -size 9500
create source\c -size 9500
create source\g -size 9500
create source\h -size 9500
create source\i -size 9500
create source\m -size 9500
create source\n -size 9500
create source\o -size 9500
qlist .
mkdir archive
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify .
.                                         -----D archive\
.          2014-01-01          2014-01-01 -A---- archive\x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- archive\x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- archive\x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- archive\x.s.dynpack [13]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\a [1]
.          2014-01-01          2014-01-01 -A---- source\b [2]
.          2014-01-01          2014-01-01 -A---- source\c [3]
.          2014-01-01          2014-01-01 -A---- source\g [4]
.          2014-01-01          2014-01-01 -A---- source\h [5]
.          2014-01-01          2014-01-01 -A---- source\i [6]
.          2014-01-01          2014-01-01 -A---- source\m [7]
.          2014-01-01          2014-01-01 -A---- source\n [8]
.          2014-01-01          2014-01-01 -A---- source\o [9]
endlist
copy source source-original

test add segment, fail after segment written
date + 1
create source\j -size 9500
create source\k -size 9500
create source\l -size 9500
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'8-write-segment-files-completed'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A--Z- x.-p.dynpack [0]
.          2014-01-01          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-03          2014-01-03 -A---- x.p.dynpack [15]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
copy archive archive-backup-1

test rerun with completion, ensure success (backup x.-0.dynpack will be used)
date + 1
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify archive
.          2014-01-01          2014-01-04 -A---- x.0.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-03          2014-01-03 -A---- x.p.dynpack [15]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target1
exitcode-verify 0
dirs-equal-verify target1 source
rmdir target1

test restore previous; invoke roll-back tool to restore to previous archive
date + 1
rmdir archive
copy archive-backup-1 archive
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A--Z- x.-p.dynpack [0]
.          2014-01-01          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-03          2014-01-03 -A---- x.p.dynpack [15]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call-with-input backup remote archive dynpack-rollback x
.y
endinput
exitcode-verify 0
lastoutput-verify
.A newer manifest also exists (x.0.dynpack). Are you sure you want to roll back? [y/n] 
.deleting x.0.dynpack
.renaming x.-0.dynpack to x.0.dynpack
.deleting x.p.dynpack
.clearing x.-p.dynpack
endoutput
list-verify archive
.          2014-01-01          2014-01-05 -A---- x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target2
exitcode-verify 0
lastoutput-verify
.Reading x.0.dynpack
.Unpacking x.a.dynpack
.Unpacking x.m.dynpack
.Unpacking x.s.dynpack
endoutput
dirs-equal-verify target2 source-original
rmdir target2


module transactionality - 4b - add segment, then remove, and rollback

test setup
date 2014-01-01
mkdir source
create source\a -size 9500
create source\b -size 9500
create source\c -size 9500
create source\g -size 9500
create source\h -size 9500
create source\i -size 9500
create source\m -size 9500
create source\n -size 9500
create source\o -size 9500
qlist .
mkdir archive
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify .
.                                         -----D archive\
.          2014-01-01          2014-01-01 -A---- archive\x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- archive\x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- archive\x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- archive\x.s.dynpack [13]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\a [1]
.          2014-01-01          2014-01-01 -A---- source\b [2]
.          2014-01-01          2014-01-01 -A---- source\c [3]
.          2014-01-01          2014-01-01 -A---- source\g [4]
.          2014-01-01          2014-01-01 -A---- source\h [5]
.          2014-01-01          2014-01-01 -A---- source\i [6]
.          2014-01-01          2014-01-01 -A---- source\m [7]
.          2014-01-01          2014-01-01 -A---- source\n [8]
.          2014-01-01          2014-01-01 -A---- source\o [9]
endlist
copy source source-original

test add segment, fail after segment written
date + 1
create source\j -size 9500
create source\k -size 9500
create source\l -size 9500
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'8-write-segment-files-completed'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A--Z- x.-p.dynpack [0]
.          2014-01-01          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-03          2014-01-03 -A---- x.p.dynpack [15]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist

test remove new segment, fail after segment write
date + 1
delete source\j
delete source\k
delete source\l
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'8-write-segment-files-completed'] dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A--Z- x.-p.dynpack [0]
.          2014-01-01          2014-01-05 -A---- x.0.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
copy archive archive-backup-1

test rerun with completion, ensure success
date + 1
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify archive
.          2014-01-01          2014-01-06 -A---- x.0.dynpack [17]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target1
exitcode-verify 0
dirs-equal-verify target1 source
rmdir target1

test restore previous; invoke roll-back tool to restore to previous archive
date + 1
rmdir archive
copy archive-backup-1 archive
list-verify archive
.          2014-01-03          2014-01-03 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A--Z- x.-p.dynpack [0]
.          2014-01-01          2014-01-05 -A---- x.0.dynpack [16]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call-with-input backup remote archive dynpack-rollback x
.y
endinput
exitcode-verify 0
lastoutput-verify
.A newer manifest also exists (x.0.dynpack). Are you sure you want to roll back? [y/n] 
.deleting x.0.dynpack
.renaming x.-0.dynpack to x.0.dynpack
.clearing x.-p.dynpack
endoutput
list-verify archive
.          2014-01-01          2014-01-07 -A---- x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
call backup dynunpack archive\x target2
exitcode-verify 0
lastoutput-verify
.Reading x.0.dynpack
.Unpacking x.a.dynpack
.Unpacking x.m.dynpack
.Unpacking x.s.dynpack
endoutput
dirs-equal-verify target2 source-original
rmdir target2


module commit process - verify create to temp name, then rename to final name (manifest and segments)

test setup
date 2014-01-01
mkdir source
create source\a -size 9500
create source\b -size 9500
create source\c -size 9500
create source\g -size 9500
create source\h -size 9500
create source\i -size 9500
create source\m -size 9500
create source\n -size 9500
create source\o -size 9500
qlist .
mkdir archive
call backup -concurrency 0 dynpack source archive\x 30000
exitcode-verify 0
list-verify .
.                                         -----D archive\
.          2014-01-01          2014-01-01 -A---- archive\x.0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- archive\x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- archive\x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- archive\x.s.dynpack [13]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\a [1]
.          2014-01-01          2014-01-01 -A---- source\b [2]
.          2014-01-01          2014-01-01 -A---- source\c [3]
.          2014-01-01          2014-01-01 -A---- source\g [4]
.          2014-01-01          2014-01-01 -A---- source\h [5]
.          2014-01-01          2014-01-01 -A---- source\i [6]
.          2014-01-01          2014-01-01 -A---- source\m [7]
.          2014-01-01          2014-01-01 -A---- source\n [8]
.          2014-01-01          2014-01-01 -A---- source\o [9]
endlist

test 2-phase commit of manifest file
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'6-write-manifest-file']/Wrote dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-02          2014-01-02 -A---- x.-0.dynpack [10]
.          2014-01-01          2014-01-01 -A---- x.0.dynpack [10]
*          [0-9-]+          [0-9-]+ -A---- x\.0\.tmp \[14\]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
date + 1
# OLD BEHAVIOR
# missing x.0.dynpack was recovered from x.-0.dynpack automatically
# CURRENT BEHAVIOR
# force failure (TODO: use failure injection to do this)
delete archive\x.0.dynpack
# manual intervention is required
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'6-write-manifest-file']/Committed dynpack source archive\x 30000
exitcode-verify not 0
lastoutput-verify -workspacepathhack
.%WORKSPACE%\source
.Reading: x.0.dynpack
.
.Error:
.Manifest file "x.0.dynpack" does not exist (backup copy "x.-0.dynpack" does exist)! Manual intervention required - may be device connectivity failure. If manifest is indeed missing, archive integrity must be verified.
*   at Backup\.Core\.DynamicPack.*$
*   at Backup\.Core\.Main.*$
endoutput
copy archive\x.-0.dynpack archive\x.0.dynpack
touch archive\x.0.dynpack -created
# END OLD/CURRENT BEHAVIOR
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage[stringequal:'6-write-manifest-file']/Committed dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-02          2014-01-02 -A---- x.-0.dynpack [10]
.          2014-01-03          2014-01-03 -A---- x.0.dynpack [14]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-01          2014-01-01 -A---- x.m.dynpack [12]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist

test 2-phase commit of segment file
date + 1
edit source\h -size 9500
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage/ArchiveSegment[stringequal:'x.m.dynpack']/Wrote dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-02          2014-01-02 -A---- x.-0.dynpack [10]
.          2014-01-05          2014-01-05 -A---- x.-m.dynpack [12]
.          2014-01-03          2014-01-05 -A---- x.0.dynpack [15]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
*          [0-9-]+          [0-9-]+ -A---- x\.m\.tmp \[16\]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist
date + 1
call backup -concurrency 0 -injectfault kill /DynamicPack/Stage/ArchiveSegment[stringequal:'x.m.dynpack']/Committed dynpack source archive\x 30000
exitcode-verify not 0
list-verify archive
.          2014-01-02          2014-01-02 -A---- x.-0.dynpack [10]
.          2014-01-05          2014-01-05 -A---- x.-m.dynpack [12]
.          2014-01-03          2014-01-06 -A---- x.0.dynpack [17]
.          2014-01-01          2014-01-01 -A---- x.a.dynpack [11]
.          2014-01-06          2014-01-06 -A---- x.m.dynpack [18]
.          2014-01-01          2014-01-01 -A---- x.s.dynpack [13]
endlist


module ensure idempotency when backup segments are removed
# Bug: A complex interaction between changing segment size, changing file hirarchy structure,
# removing segment backups, and losing current manifest results in data loss.
# When manifest is lost and old manifest is used, a segment of a given name that was updated
# exists but has different content than the manifest thinks it has.

# current workaround: require manual intervention when manifest is missing but backup manifest exists

test setup
date 2015-01-01
mkdir source
create source\a -size 90000
create source\b1 -size 45000
create source\b3 -size 45000
create source\d -size 90000
qlist .
mkdir archive
call backup -concurrency 0 dynpack source archive\x 100000
exitcode-verify 0
list-verify .
.                                         -----D archive\
.          2015-01-01          2015-01-01 -A---- archive\x.0.dynpack [5]
.          2015-01-01          2015-01-01 -A---- archive\x.a.dynpack [6]
.          2015-01-01          2015-01-01 -A---- archive\x.m.dynpack [7]
.          2015-01-01          2015-01-01 -A---- archive\x.s.dynpack [8]
.                                         -----D source\
.          2015-01-01          2015-01-01 -A---- source\a [1]
.          2015-01-01          2015-01-01 -A---- source\b1 [2]
.          2015-01-01          2015-01-01 -A---- source\b3 [3]
.          2015-01-01          2015-01-01 -A---- source\d [4]
endlist

test update archive causing segment to split, and fail before removing backup manifest
date + 1
create source\b2 -size 45000
date + 1
qlist .
call backup -concurrency 0 -injectfault proof:proof-killed1 throw /DynamicPack/Stage[stringequal:'8-write-segment-files-completed'] dynpack source archive\x 100000
exitcode-verify not 0
list-verify .
.                                         -----D archive\
.          2015-01-03          2015-01-03 -A---- archive\x.-0.dynpack [5]
.          2015-01-03          2015-01-03 -A---- archive\x.-m.dynpack [7]
.          2015-01-03          2015-01-03 -A--Z- archive\x.-p.dynpack [0]
.          2015-01-01          2015-01-03 -A---- archive\x.0.dynpack [10]
.          2015-01-01          2015-01-01 -A---- archive\x.a.dynpack [6]
.          2015-01-01          2015-01-03 -A---- archive\x.m.dynpack [11]
.          2015-01-03          2015-01-03 -A---- archive\x.p.dynpack [12]
.          2015-01-01          2015-01-01 -A---- archive\x.s.dynpack [8]
*          [0-9-]+          [0-9-]+ -A---- proof-killed1 \[13\]
.                                         -----D source\
.          2015-01-01          2015-01-01 -A---- source\a [1]
.          2015-01-01          2015-01-01 -A---- source\b1 [2]
.          2015-01-02          2015-01-02 -A---- source\b2 [9]
.          2015-01-01          2015-01-01 -A---- source\b3 [3]
.          2015-01-01          2015-01-01 -A---- source\d [4]
endlist
delete proof-killed1

test simulate system failure that destroys most recent manifest combined with file system change
date + 1
# simulate user cleaning up backup files
delete archive\x.-m.dynpack
# simulate system failure destroying current manifest
delete archive\x.0.dynpack
# roll back directory hierarchy change
delete source\b2
date + 1
qlist .
# OLD BEHAVIOR (automatic use of backup manifest when current manifest is missing)
# call backup -concurrency 0 dynpack source archive\x 100000
# exitcode-verify 0
# CURRENT BEHAVIOR (require manual intervention)
call backup -concurrency 0 dynpack source archive\x 100000
exitcode-verify not 0
lastoutput-verify -workspacepathhack
.%WORKSPACE%\source
.Reading: x.0.dynpack
.
.Error:
.Manifest file "x.0.dynpack" does not exist (backup copy "x.-0.dynpack" does exist)! Manual intervention required - may be device connectivity failure. If manifest is indeed missing, archive integrity must be verified.
*   at Backup\.Core\.DynamicPack.*$
*   at Backup\.Core\.Main.*$
endoutput
# manual intervention
move archive\x.-0.dynpack archive\x.0.dynpack
touch archive\x.0.dynpack -created
call backup -concurrency 0 dynpack source archive\x 100000
exitcode-verify 0
# END OLD/CURRENT BEHAVIOR
list-verify .
.                                         -----D archive\
.          2015-01-05          2015-01-05 -A---- archive\x.0.dynpack [14]
.          2015-01-01          2015-01-01 -A---- archive\x.a.dynpack [6]
.          2015-01-01          2015-01-03 -A---- archive\x.m.dynpack [11]
.          2015-01-01          2015-01-01 -A---- archive\x.s.dynpack [8]
.                                         -----D source\
.          2015-01-01          2015-01-01 -A---- source\a [1]
.          2015-01-01          2015-01-01 -A---- source\b1 [2]
.          2015-01-01          2015-01-01 -A---- source\b3 [3]
.          2015-01-01          2015-01-01 -A---- source\d [4]
endlist

test check for valid archive structure
date + 1
mkdir output
date + 1
qlist .
# OLD BEHAVIOR
# if bug occurs, this may fail because segment "m" has the wrong serial number
#call backup -concurrency 0 dynunpack archive\x output
#exitcode-verify 0
# CURRENT BEHAVIOR
call backup -concurrency 0 dynunpack archive\x output
exitcode-verify not 0
lastoutput-verify -workspacepathhack
.Reading x.0.dynpack
.Unpacking x.a.dynpack
.Segment m: serial number 5 is invalid
.Unpacking x.m.dynpack
endoutput
# END OLD/CURRENT BEHAVIOR
list-verify .
.                                         -----D archive\
.          2015-01-05          2015-01-05 -A---- archive\x.0.dynpack [14]
.          2015-01-01          2015-01-01 -A---- archive\x.a.dynpack [6]
.          2015-01-01          2015-01-03 -A---- archive\x.m.dynpack [11]
.          2015-01-01          2015-01-01 -A---- archive\x.s.dynpack [8]
.                                         -----D output\
.          2015-01-01          2015-01-01 -A---- output\a [1]
# OLD BEHAVIOR
#.          2015-01-01          2015-01-01 -A---- output\b1 [2]
## if bug occurs, this file (b3) may be missing
#.          2015-01-01          2015-01-01 -A---- output\b3 [3]
#.          2015-01-01          2015-01-01 -A---- output\d [4]
# CURRENT BEHAVIOR (extract aborts when "m" is opened)
# END OLD/CURRENT BEHAVIOR
.                                         -----D source\
.          2015-01-01          2015-01-01 -A---- source\a [1]
.          2015-01-01          2015-01-01 -A---- source\b1 [2]
.          2015-01-01          2015-01-01 -A---- source\b3 [3]
.          2015-01-01          2015-01-01 -A---- source\d [4]
endlist
# OLD BEHAVIOR
# if bug occurs, output will not match source
#dirs-equal-verify source output
# CURRENT BEHAVIOR (extract aborts when "m" is opened)
# will not match so comparison is skipped (see preceding command for expected output)
# END OLD/CURRENT BEHAVIOR


# TODO - unresolved:
# - Should "-verify" rename bad segments to -x form [proposed behavior] or always delete outright [current behavior]?
