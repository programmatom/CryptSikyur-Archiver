command backup ..\..\..\..\Backup\Backup\bin\Debug\Backup.exe -date %DATE%
#opencover backup

date-format yyyy-MM-dd

fail-pause on


module restartable file updates

mkdir source
mkdir archive

test setup
date 2014-01-01
create source\z.txt
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A---- archive\2014-01-01T00+00+00\z.txt [1]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test add file...
date + 1
create source\a.txt
date + 1
call backup backup source archive -nofinish
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-02          2014-01-02 -A---- archive\9999-12-31T23+59+59\a.txt [2]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-02 -A---- source\a.txt [2]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test rerun no changes and commit
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A---- archive\2014-01-04T00+00+00\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-02 -A---- source\a.txt [2]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test modify file...
date + 1
edit source\a.txt
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-02          2014-01-05 -A---- archive\9999-12-31T23+59+59\a.txt [3]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-05 -A---- source\a.txt [3]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test rerun no changes and commit
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A---- archive\2014-01-07T00+00+00\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-05 -A---- source\a.txt [3]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test modify file...
date + 1
edit source\a.txt
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-02          2014-01-08 -A---- archive\9999-12-31T23+59+59\a.txt [4]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-08 -A---- source\a.txt [4]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test modify file again...
date + 1
edit source\a.txt
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-02          2014-01-10 -A---- archive\9999-12-31T23+59+59\a.txt [5]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-10 -A---- source\a.txt [5]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test rerun no changes and commit
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-12T00+00+00\
.          2014-01-02          2014-01-10 -A---- archive\2014-01-12T00+00+00\a.txt [5]
.          2014-01-01          2014-01-01 -A---- archive\2014-01-12T00+00+00\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-10 -A---- source\a.txt [5]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test no changes...
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-12T00+00+00\
.          2014-01-02          2014-01-10 -A--Z- archive\2014-01-12T00+00+00\a.txt [0]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-12T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-02          2014-01-10 -A---- archive\9999-12-31T23+59+59\a.txt [5]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-10 -A---- source\a.txt [5]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test no changes, again (and extra file)...
date + 1
# add another file to ensure nothing happened to a.txt correctly (vs. nothing happening, but incorrectly)
create source\b.txt
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-12T00+00+00\
.          2014-01-02          2014-01-10 -A--Z- archive\2014-01-12T00+00+00\a.txt [0]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-12T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-02          2014-01-10 -A---- archive\9999-12-31T23+59+59\a.txt [5]
.          2014-01-14          2014-01-14 -A---- archive\9999-12-31T23+59+59\b.txt [6]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-10 -A---- source\a.txt [5]
.          2014-01-14          2014-01-14 -A---- source\b.txt [6]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test delete file (pushback)...
date + 1
delete source\a.txt
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-12T00+00+00\
.          2014-01-02          2014-01-10 -A---- archive\2014-01-12T00+00+00\a.txt [5]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-12T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-14          2014-01-14 -A---- archive\9999-12-31T23+59+59\b.txt [6]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-14          2014-01-14 -A---- source\b.txt [6]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test delete new file (void)...
date + 1
delete source\b.txt
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-12T00+00+00\
.          2014-01-02          2014-01-10 -A---- archive\2014-01-12T00+00+00\a.txt [5]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-12T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test create new file (overwrite)...
date + 1
create source\a.txt
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-12T00+00+00\
.          2014-01-02          2014-01-10 -A---- archive\2014-01-12T00+00+00\a.txt [5]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-12T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-20          2014-01-20 -A---- archive\9999-12-31T23+59+59\a.txt [7]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-20          2014-01-20 -A---- source\a.txt [7]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test delete new file (void overwrite)...
date + 1
delete source\a.txt
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-12T00+00+00\
.          2014-01-02          2014-01-10 -A---- archive\2014-01-12T00+00+00\a.txt [5]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-12T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test restore old file...
date + 1
copy archive\2014-01-12T00+00+00\a.txt source\a.txt
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-12T00+00+00\
.          2014-01-02          2014-01-10 -A--Z- archive\2014-01-12T00+00+00\a.txt [0]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-12T00+00+00\z.txt [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-02          2014-01-10 -A---- archive\9999-12-31T23+59+59\a.txt [5]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-10 -A---- source\a.txt [5]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist

test commit
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-04T00+00+00\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-04T00+00+00\a.txt [2]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-04T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-07T00+00+00\
.          2014-01-02          2014-01-05 -A---- archive\2014-01-07T00+00+00\a.txt [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-07T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-12T00+00+00\
.          2014-01-02          2014-01-10 -A--Z- archive\2014-01-12T00+00+00\a.txt [0]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-12T00+00+00\z.txt [0]
.                                         -----D archive\2014-01-26T00+00+00\
.          2014-01-02          2014-01-10 -A---- archive\2014-01-26T00+00+00\a.txt [5]
.          2014-01-01          2014-01-01 -A---- archive\2014-01-26T00+00+00\z.txt [1]
.                                         -----D source\
.          2014-01-02          2014-01-10 -A---- source\a.txt [5]
.          2014-01-01          2014-01-01 -A---- source\z.txt [1]
endlist


module restartable file/directory disambiguation

mkdir source
mkdir archive

test setup
date 2014-01-01
create source\z
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A---- archive\2014-01-01T00+00+00\z [1]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test add file...
date + 1
create source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-02          2014-01-02 -A---- archive\9999-12-31T23+59+59\a [2]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.          2014-01-02          2014-01-02 -A---- source\a [2]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace new file with directory...
date + 1
delete source\a
mkdir source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\a\
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace new directory with file...
date + 1
rmdir source\a
create source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-06          2014-01-06 -A---- archive\9999-12-31T23+59+59\a [3]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.          2014-01-06          2014-01-06 -A---- source\a [3]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test rerun no changes and commit
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A---- archive\2014-01-08T00+00+00\z [1]
.                                         -----D source\
.          2014-01-06          2014-01-06 -A---- source\a [3]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace new file with directory...
date + 1
delete source\a
mkdir source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\a\
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test delete new directory and restore old file...
date + 1
rmdir source\a
copy archive\2014-01-08T00+00+00\a source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A--Z- archive\2014-01-08T00+00+00\a [0]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-06          2014-01-06 -A---- archive\9999-12-31T23+59+59\a [3]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.          2014-01-06          2014-01-06 -A---- source\a [3]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace (restored) old file with new filled directory...
date + 1
delete source\a
mkdir source\a
create source\a\b
mkdir source\a\c
create source\a\c\d
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\a\
.          2014-01-13          2014-01-13 -A---- archive\9999-12-31T23+59+59\a\b [4]
.                                         -----D archive\9999-12-31T23+59+59\a\c\
.          2014-01-13          2014-01-13 -A---- archive\9999-12-31T23+59+59\a\c\d [5]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-13          2014-01-13 -A---- source\a\b [4]
.                                         -----D source\a\c\
.          2014-01-13          2014-01-13 -A---- source\a\c\d [5]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace new filled directory with (restored) old file (rollback)...
date + 1
rmdir source\a
copy archive\2014-01-08T00+00+00\a source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A--Z- archive\2014-01-08T00+00+00\a [0]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-06          2014-01-06 -A---- archive\9999-12-31T23+59+59\a [3]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.          2014-01-06          2014-01-06 -A---- source\a [3]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace old file with new directory and commit
date + 1
delete source\a
mkdir source\a
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\2014-01-18T00+00+00\
.                                         -----D archive\2014-01-18T00+00+00\a\
.          2014-01-01          2014-01-01 -A---- archive\2014-01-18T00+00+00\z [1]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace directory new file...
date + 1
rmdir source\a
create source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\2014-01-18T00+00+00\
.                                         -----D archive\2014-01-18T00+00+00\a\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-18T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-19          2014-01-19 -A---- archive\9999-12-31T23+59+59\a [6]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.          2014-01-19          2014-01-19 -A---- source\a [6]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace new file with old directory (rollback)...
date + 1
delete source\a
mkdir source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\2014-01-18T00+00+00\
.                                         -----D archive\2014-01-18T00+00+00\a\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-18T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\a\
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test add directory content and commit
date + 1
create source\a\b
date + 1
mkdir source\a\c
date + 1
create source\a\c\d
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\2014-01-18T00+00+00\
.                                         -----D archive\2014-01-18T00+00+00\a\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-18T00+00+00\z [0]
.                                         -----D archive\2014-01-26T00+00+00\
.                                         -----D archive\2014-01-26T00+00+00\a\
.          2014-01-23          2014-01-23 -A---- archive\2014-01-26T00+00+00\a\b [7]
.                                         -----D archive\2014-01-26T00+00+00\a\c\
.          2014-01-25          2014-01-25 -A---- archive\2014-01-26T00+00+00\a\c\d [8]
.          2014-01-01          2014-01-01 -A---- archive\2014-01-26T00+00+00\z [1]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-23          2014-01-23 -A---- source\a\b [7]
.                                         -----D source\a\c\
.          2014-01-25          2014-01-25 -A---- source\a\c\d [8]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace directory hierarchy with new file...
date + 1
rmdir source\a
create source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\2014-01-18T00+00+00\
.                                         -----D archive\2014-01-18T00+00+00\a\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-18T00+00+00\z [0]
.                                         -----D archive\2014-01-26T00+00+00\
.                                         -----D archive\2014-01-26T00+00+00\a\
.          2014-01-23          2014-01-23 -A---- archive\2014-01-26T00+00+00\a\b [7]
.                                         -----D archive\2014-01-26T00+00+00\a\c\
.          2014-01-25          2014-01-25 -A---- archive\2014-01-26T00+00+00\a\c\d [8]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-26T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-27          2014-01-27 -A---- archive\9999-12-31T23+59+59\a [9]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.          2014-01-27          2014-01-27 -A---- source\a [9]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test remove new file and put different content...
date + 1
delete source\a
date + 1
mkdir source\a
date + 1
create source\a\b
date + 1
mkdir source\a\c
date + 1
create source\a\c\d
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\2014-01-18T00+00+00\
.                                         -----D archive\2014-01-18T00+00+00\a\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-18T00+00+00\z [0]
.                                         -----D archive\2014-01-26T00+00+00\
.                                         -----D archive\2014-01-26T00+00+00\a\
.          2014-01-23          2014-01-23 -A---- archive\2014-01-26T00+00+00\a\b [7]
.                                         -----D archive\2014-01-26T00+00+00\a\c\
.          2014-01-25          2014-01-25 -A---- archive\2014-01-26T00+00+00\a\c\d [8]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-26T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\a\
.          2014-01-31          2014-01-31 -A---- archive\9999-12-31T23+59+59\a\b [10]
.                                         -----D archive\9999-12-31T23+59+59\a\c\
.          2014-02-02          2014-02-02 -A---- archive\9999-12-31T23+59+59\a\c\d [11]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-31          2014-01-31 -A---- source\a\b [10]
.                                         -----D source\a\c\
.          2014-02-02          2014-02-02 -A---- source\a\c\d [11]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace directory hierarchy with new file...
date + 1
rmdir source\a
create source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\2014-01-18T00+00+00\
.                                         -----D archive\2014-01-18T00+00+00\a\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-18T00+00+00\z [0]
.                                         -----D archive\2014-01-26T00+00+00\
.                                         -----D archive\2014-01-26T00+00+00\a\
.          2014-01-23          2014-01-23 -A---- archive\2014-01-26T00+00+00\a\b [7]
.                                         -----D archive\2014-01-26T00+00+00\a\c\
.          2014-01-25          2014-01-25 -A---- archive\2014-01-26T00+00+00\a\c\d [8]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-26T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-02-04          2014-02-04 -A---- archive\9999-12-31T23+59+59\a [12]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.          2014-02-04          2014-02-04 -A---- source\a [12]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test remove new file and restore old directory structure...
date + 1
delete source\a
mkdir source\a
copy archive\2014-01-26T00+00+00\a\b source\a\b
mkdir source\a\c
copy archive\2014-01-26T00+00+00\a\c\d source\a\c\d
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\2014-01-18T00+00+00\
.                                         -----D archive\2014-01-18T00+00+00\a\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-18T00+00+00\z [0]
.                                         -----D archive\2014-01-26T00+00+00\
.                                         -----D archive\2014-01-26T00+00+00\a\
.          2014-01-23          2014-01-23 -A--Z- archive\2014-01-26T00+00+00\a\b [0]
.                                         -----D archive\2014-01-26T00+00+00\a\c\
.          2014-01-25          2014-01-25 -A--Z- archive\2014-01-26T00+00+00\a\c\d [0]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-26T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\a\
.          2014-01-23          2014-01-23 -A---- archive\9999-12-31T23+59+59\a\b [7]
.                                         -----D archive\9999-12-31T23+59+59\a\c\
.          2014-01-25          2014-01-25 -A---- archive\9999-12-31T23+59+59\a\c\d [8]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-23          2014-01-23 -A---- source\a\b [7]
.                                         -----D source\a\c\
.          2014-01-25          2014-01-25 -A---- source\a\c\d [8]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist

test replace (restored) directory hierarchy with new file (deep rollback)...
date + 1
rmdir source\a
create source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-01T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-01T00+00+00\z [0]
.                                         -----D archive\2014-01-08T00+00+00\
.          2014-01-06          2014-01-06 -A---- archive\2014-01-08T00+00+00\a [3]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-08T00+00+00\z [0]
.                                         -----D archive\2014-01-18T00+00+00\
.                                         -----D archive\2014-01-18T00+00+00\a\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-18T00+00+00\z [0]
.                                         -----D archive\2014-01-26T00+00+00\
.                                         -----D archive\2014-01-26T00+00+00\a\
.          2014-01-23          2014-01-23 -A---- archive\2014-01-26T00+00+00\a\b [7]
.                                         -----D archive\2014-01-26T00+00+00\a\c\
.          2014-01-25          2014-01-25 -A---- archive\2014-01-26T00+00+00\a\c\d [8]
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-26T00+00+00\z [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-02-08          2014-02-08 -A---- archive\9999-12-31T23+59+59\a [13]
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\z [1]
.                                         -----D source\
.          2014-02-08          2014-02-08 -A---- source\a [13]
.          2014-01-01          2014-01-01 -A---- source\z [1]
endlist


module case insensitive handling 1

mkdir source
mkdir archive

test setup
date 2014-01-01
create source\a
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-02T00+00+00\
.          2014-01-01          2014-01-01 -A---- archive\2014-01-02T00+00+00\a [1]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\a [1]
endlist

test rename case with no change...
date + 1
move source\a source\A
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-02T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-02T00+00+00\a [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\A [1]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\A [1]
endlist

test rename case with no change...
date + 1
move source\A source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-02T00+00+00\
.          2014-01-01          2014-01-01 -A--Z- archive\2014-01-02T00+00+00\a [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-01          2014-01-01 -A---- archive\9999-12-31T23+59+59\a [1]
.                                         -----D source\
.          2014-01-01          2014-01-01 -A---- source\a [1]
endlist

test change file to new directory of different case and commit
delete source\a
date + 1
mkdir source\A
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-02T00+00+00\
.          2014-01-01          2014-01-01 -A---- archive\2014-01-02T00+00+00\a [1]
.                                         -----D archive\2014-01-08T00+00+00\
.                                         -----D archive\2014-01-08T00+00+00\A\
.                                         -----D source\
.                                         -----D source\A\
endlist

test change directory to file of different case...
rmdir source\A
date + 1
create source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-02T00+00+00\
.          2014-01-01          2014-01-01 -A---- archive\2014-01-02T00+00+00\a [1]
.                                         -----D archive\2014-01-08T00+00+00\
.                                         -----D archive\2014-01-08T00+00+00\A\
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-09          2014-01-09 -A---- archive\9999-12-31T23+59+59\a [2]
.                                         -----D source\
.          2014-01-09          2014-01-09 -A---- source\a [2]
endlist


test change new file to filled directory of different case...
delete source\a
date + 1
mkdir source\A
date + 1
create source\A\b
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-02T00+00+00\
.          2014-01-01          2014-01-01 -A---- archive\2014-01-02T00+00+00\a [1]
.                                         -----D archive\2014-01-08T00+00+00\
.                                         -----D archive\2014-01-08T00+00+00\A\
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\A\
.          2014-01-12          2014-01-12 -A---- archive\9999-12-31T23+59+59\A\b [3]
.                                         -----D source\
.                                         -----D source\A\
.          2014-01-12          2014-01-12 -A---- source\A\b [3]
endlist


# not worth fixing this case (committing backup and rerunning will pick up modified directory case)

test rename case of filled directory with unfinished checkpoint...
date + 1
move source\A source\a
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-02T00+00+00\
.          2014-01-01          2014-01-01 -A---- archive\2014-01-02T00+00+00\a [1]
.                                         -----D archive\2014-01-08T00+00+00\
.                                         -----D archive\2014-01-08T00+00+00\A\
.                                         -----D archive\9999-12-31T23+59+59\
# should be:
#.                                         -----D archive\9999-12-31T23+59+59\a\
#.          2014-01-12          2014-01-12 -A---- archive\9999-12-31T23+59+59\a\b [3]
.                                         -----D archive\9999-12-31T23+59+59\A\
.          2014-01-12          2014-01-12 -A---- archive\9999-12-31T23+59+59\A\b [3]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-12          2014-01-12 -A---- source\a\b [3]
endlist


module case insensitive handling 2

mkdir source
mkdir archive

test create directory with content
date 2014-01-01
mkdir source\A
date + 1
create source\A\b
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-03T00+00+00\
.                                         -----D archive\2014-01-03T00+00+00\A\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-03T00+00+00\A\b [1]
.                                         -----D source\
.                                         -----D source\A\
.          2014-01-02          2014-01-02 -A---- source\A\b [1]
endlist

test rename case of filled directory with no unfinished checkpoint
date + 1
move source\A source\a
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-03T00+00+00\
.                                         -----D archive\2014-01-03T00+00+00\A\
.          2014-01-02          2014-01-02 -A--Z- archive\2014-01-03T00+00+00\A\b [0]
.                                         -----D archive\2014-01-05T00+00+00\
.                                         -----D archive\2014-01-05T00+00+00\a\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-05T00+00+00\a\b [1]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-02          2014-01-02 -A---- source\a\b [1]
endlist

test setup unfinished checkpoint...
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-03T00+00+00\
.                                         -----D archive\2014-01-03T00+00+00\A\
.          2014-01-02          2014-01-02 -A--Z- archive\2014-01-03T00+00+00\A\b [0]
.                                         -----D archive\2014-01-05T00+00+00\
.                                         -----D archive\2014-01-05T00+00+00\a\
.          2014-01-02          2014-01-02 -A--Z- archive\2014-01-05T00+00+00\a\b [0]
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\a\
.          2014-01-02          2014-01-02 -A---- archive\9999-12-31T23+59+59\a\b [1]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-02          2014-01-02 -A---- source\a\b [1]
endlist

test replace directory with file of same name different case...
date + 1
rmdir source\a
date + 1
create source\A
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-03T00+00+00\
.                                         -----D archive\2014-01-03T00+00+00\A\
.          2014-01-02          2014-01-02 -A--Z- archive\2014-01-03T00+00+00\A\b [0]
.                                         -----D archive\2014-01-05T00+00+00\
.                                         -----D archive\2014-01-05T00+00+00\a\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-05T00+00+00\a\b [1]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-08          2014-01-08 -A---- archive\9999-12-31T23+59+59\A [2]
.                                         -----D source\
.          2014-01-08          2014-01-08 -A---- source\A [2]
endlist


module deep rollback followed by modified file (deferred copy)

mkdir source
mkdir archive

test create initial directory and files
date 2014-01-01
mkdir source\a
date + 1
create source\a\x
date + 1
create source\a\y
date + 1
create source\b
date + 1
create source\c
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-06T00+00+00\
.                                         -----D archive\2014-01-06T00+00+00\a\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-06T00+00+00\a\x [1]
.          2014-01-03          2014-01-03 -A---- archive\2014-01-06T00+00+00\a\y [2]
.          2014-01-04          2014-01-04 -A---- archive\2014-01-06T00+00+00\b [3]
.          2014-01-05          2014-01-05 -A---- archive\2014-01-06T00+00+00\c [4]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-02          2014-01-02 -A---- source\a\x [1]
.          2014-01-03          2014-01-03 -A---- source\a\y [2]
.          2014-01-04          2014-01-04 -A---- source\b [3]
.          2014-01-05          2014-01-05 -A---- source\c [4]
endlist

test unfinished checkpoint...
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-06T00+00+00\
.                                         -----D archive\2014-01-06T00+00+00\a\
.          2014-01-02          2014-01-02 -A--Z- archive\2014-01-06T00+00+00\a\x [0]
.          2014-01-03          2014-01-03 -A--Z- archive\2014-01-06T00+00+00\a\y [0]
.          2014-01-04          2014-01-04 -A--Z- archive\2014-01-06T00+00+00\b [0]
.          2014-01-05          2014-01-05 -A--Z- archive\2014-01-06T00+00+00\c [0]
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\a\
.          2014-01-02          2014-01-02 -A---- archive\9999-12-31T23+59+59\a\x [1]
.          2014-01-03          2014-01-03 -A---- archive\9999-12-31T23+59+59\a\y [2]
.          2014-01-04          2014-01-04 -A---- archive\9999-12-31T23+59+59\b [3]
.          2014-01-05          2014-01-05 -A---- archive\9999-12-31T23+59+59\c [4]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-02          2014-01-02 -A---- source\a\x [1]
.          2014-01-03          2014-01-03 -A---- source\a\y [2]
.          2014-01-04          2014-01-04 -A---- source\b [3]
.          2014-01-05          2014-01-05 -A---- source\c [4]
endlist

test replace directory with file (deep rollback, deferred copy), modify next file (proper enumerator advancement)...
date + 1
rmdir source\a
create source\a
date + 1
edit source\b
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-06T00+00+00\
.                                         -----D archive\2014-01-06T00+00+00\a\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-06T00+00+00\a\x [1]
.          2014-01-03          2014-01-03 -A---- archive\2014-01-06T00+00+00\a\y [2]
.          2014-01-04          2014-01-04 -A---- archive\2014-01-06T00+00+00\b [3]
.          2014-01-05          2014-01-05 -A--Z- archive\2014-01-06T00+00+00\c [0]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-08          2014-01-08 -A---- archive\9999-12-31T23+59+59\a [5]
.          2014-01-04          2014-01-09 -A---- archive\9999-12-31T23+59+59\b [6]
.          2014-01-05          2014-01-05 -A---- archive\9999-12-31T23+59+59\c [4]
.                                         -----D source\
.          2014-01-08          2014-01-08 -A---- source\a [5]
.          2014-01-04          2014-01-09 -A---- source\b [6]
.          2014-01-05          2014-01-05 -A---- source\c [4]
endlist

reset

mkdir source
mkdir archive

test create initial directory and files (end case)
date 2014-01-01
mkdir source\a
date + 1
create source\a\x
date + 1
create source\a\y
date + 1
date + 1
date + 1
call backup backup source archive
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-06T00+00+00\
.                                         -----D archive\2014-01-06T00+00+00\a\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-06T00+00+00\a\x [1]
.          2014-01-03          2014-01-03 -A---- archive\2014-01-06T00+00+00\a\y [2]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-02          2014-01-02 -A---- source\a\x [1]
.          2014-01-03          2014-01-03 -A---- source\a\y [2]
endlist

test unfinished checkpoint (end case)...
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-06T00+00+00\
.                                         -----D archive\2014-01-06T00+00+00\a\
.          2014-01-02          2014-01-02 -A--Z- archive\2014-01-06T00+00+00\a\x [0]
.          2014-01-03          2014-01-03 -A--Z- archive\2014-01-06T00+00+00\a\y [0]
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\a\
.          2014-01-02          2014-01-02 -A---- archive\9999-12-31T23+59+59\a\x [1]
.          2014-01-03          2014-01-03 -A---- archive\9999-12-31T23+59+59\a\y [2]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-02          2014-01-02 -A---- source\a\x [1]
.          2014-01-03          2014-01-03 -A---- source\a\y [2]
endlist

test replace directory with file (deep rollback, deferred copy), modify next file (proper enumerator advancement) (end case)...
date + 1
rmdir source\a
create source\a
date + 1
date + 1
call backup backup source archive -nofinish
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-06T00+00+00\
.                                         -----D archive\2014-01-06T00+00+00\a\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-06T00+00+00\a\x [1]
.          2014-01-03          2014-01-03 -A---- archive\2014-01-06T00+00+00\a\y [2]
.                                         -----D archive\9999-12-31T23+59+59\
.          2014-01-08          2014-01-08 -A---- archive\9999-12-31T23+59+59\a [3]
.                                         -----D source\
.          2014-01-08          2014-01-08 -A---- source\a [3]
endlist

reset

mkdir source
mkdir archive

test create initial directory and files (excluded items end case)
date 2014-01-01
mkdir source\a
date + 1
create source\a\x
date + 1
create source\a\y
date + 1
date + 1
date + 1
call backup backup source archive -skip .log -exclude source\dummy
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-06T00+00+00\
.                                         -----D archive\2014-01-06T00+00+00\a\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-06T00+00+00\a\x [1]
.          2014-01-03          2014-01-03 -A---- archive\2014-01-06T00+00+00\a\y [2]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-02          2014-01-02 -A---- source\a\x [1]
.          2014-01-03          2014-01-03 -A---- source\a\y [2]
endlist

test unfinished checkpoint (excluded items end case)...
date + 1
call backup backup source archive -nofinish -skip .log -exclude source\dummy
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-06T00+00+00\
.                                         -----D archive\2014-01-06T00+00+00\a\
.          2014-01-02          2014-01-02 -A--Z- archive\2014-01-06T00+00+00\a\x [0]
.          2014-01-03          2014-01-03 -A--Z- archive\2014-01-06T00+00+00\a\y [0]
.                                         -----D archive\9999-12-31T23+59+59\
.                                         -----D archive\9999-12-31T23+59+59\a\
.          2014-01-02          2014-01-02 -A---- archive\9999-12-31T23+59+59\a\x [1]
.          2014-01-03          2014-01-03 -A---- archive\9999-12-31T23+59+59\a\y [2]
.                                         -----D source\
.                                         -----D source\a\
.          2014-01-02          2014-01-02 -A---- source\a\x [1]
.          2014-01-03          2014-01-03 -A---- source\a\y [2]
endlist

test replace directory with file (deep rollback, deferred copy), modify next file (proper enumerator advancement) (excluded items end case)...
date + 1
rmdir source\a
create source\a
date + 1
date + 1
call backup backup source archive -skip .log -exclude source\dummy
exitcode-verify 0
list-verify .
.                                         -----D archive\
.                                         -----D archive\2014-01-06T00+00+00\
.                                         -----D archive\2014-01-06T00+00+00\a\
.          2014-01-02          2014-01-02 -A---- archive\2014-01-06T00+00+00\a\x [1]
.          2014-01-03          2014-01-03 -A---- archive\2014-01-06T00+00+00\a\y [2]
.                                         -----D archive\2014-01-10T00+00+00\
.          2014-01-08          2014-01-08 -A---- archive\2014-01-10T00+00+00\a [3]
.                                         -----D source\
.          2014-01-08          2014-01-08 -A---- source\a [3]
endlist
